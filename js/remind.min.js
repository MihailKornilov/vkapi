var _remindAdd=function(){var b=_dialog({top:40,width:480,head:"Внесение нового напоминания",content:'<table class="_remind-add-tab">'+(window.ZI?'<tr><td class="label">Заявка:<td><b>'+ZI.name+"</b>":"")+(window.CLIENT?'<tr><td class="label">Клиент:<td>'+CLIENT.fio:"")+'<tr><td class="label">Задача:<td><input type="text" id="txt" /><tr><td class="label top">Подробно:<td><textarea id="about"></textarea><tr><td class="label">День выполнения:<td><input type="hidden" id="day" /></table><input type="hidden" id="client_id" value="'+
(window.CLIENT?CLIENT.id:0)+'"><input type="hidden" id="zayav_id" value="'+(window.ZI?ZI.id:0)+'">',submit:function(){var a={op:"remind_add",from:window.ZI?"zayav":window.CLIENT?"client":"",client_id:$("#client_id").val(),zayav_id:$("#zayav_id").val(),txt:$.trim($("#txt").val()),about:$("#about").val(),day:$("#day").val()};a.txt?(b.process(),$.post(AJAX_MAIN,a,function(c){if(c.success)switch(b.close(),_msg("Напоминание внесено"),a.from){case "zayav":$("#_remind-zayav").html(c.html);REMIND.active++;
break;case "client":$("#remind-spisok").html(c.html);break;default:$("td.left").html(c.html)}else b.abort()},"json")):(b.err("Не указано содержание задачи"),$("#txt").focus())}});$("#txt").focus();$("#about").autosize();$("#day")._calendar();return!1},remindFilter=function(b,a){return{op:"remind_spisok",status:"_remind-status"==a?$("#_remind-status").val():$("#remind_filter_status").val()}},remindSpisok=function(b,a){$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,remindFilter(b,a),function(a){$("#mainLinks").removeClass("busy");
a.success&&$(".left").html(a.html)},"json")};
$(document).on("click","._remind-add",_remindAdd).on("click","._remind-unit .action",function(){function b(a){var b={op:"remind_action",from:window.ZI?"zayav":window.CLIENT?"client":"",id:c,status:a,day:$("#remind_day").val(),reason:$("#reason")._select("inp")};1==a&&b.day==d?e.err("Выберите другой день"):1!=a||b.reason?$.post(AJAX_MAIN,b,function(a){a.success&&(e.close(),_msg("Данные изменены!"),$(b.from?"#remind-spisok":"td.left").html(a.html))},"json"):e.err("Не указана причина")}for(var a=$(this);!a.hasClass("_remind-unit");)a=
a.parent();var c=a.attr("val"),f=a.find(".hdtxt").html(),d=a.find(".ruday").val(),e=_dialog({top:30,head:"Изменение статуса напоминания",content:'<div id="_remind-action-tab"><div id="hd">'+f+'</div><div class="st c1" val="1">Указать другой день<div class="about">Перенести напоминание на другой день.</div></div><div class="st c2" val="2">Выполнено<div class="about">Задание выполнено успешно.</div></div><div class="st c0" val="0">Отмена<div class="about">Отмена напоминания по какой-либо причине.</div></div><table id="ra-tab"><tr><td class="label">Новый день:<td><input type="hidden" id="remind_day" value="'+
d+'" /><tr><td class="label">Причина:<td><input type="hidden" id="reason" /></table></div>',butSubmit:"",butCancel:"Закрыть",submit:function(){b(1)}});$("#remind_day")._calendar();$("#reason")._select({width:225,spisok:[],write:!0});$("#reason")._select("process");$.post(AJAX_MAIN,{op:"remind_reason_spisok"},function(a){$("#reason")._select("cancel");a.success&&$("#reason")._select(a.spisok)},"json");$(".st").click(function(){var a=$(this).attr("val");1==a?($(".c2,.c0").hide(),$("#ra-tab").show(),
e.butSubmit("Применить")):($("#_remind-action-tab").addClass("busy"),b(a))})}).on("click","._remind-unit .hd-edit",function(){function b(){var a={op:"remind_head_edit",from:window.ZI?"zayav":window.CLIENT?"client":"",id:c,txt:$("#hdtxt").val(),about:$("#hd-about").val()};a.txt?(d.process(),$.post(AJAX_MAIN,a,function(b){b.success?(d.close(),_msg("Данные изменены"),$(a.from?"#remind-spisok":"td.left").html(b.html)):d.abort()},"json")):d.err("Не указано содержание задачи")}for(var a=$(this);!a.hasClass("_remind-unit");)a=
a.parent();var c=a.attr("val"),f=a.find(".hdtxt").html(),a=a.find(".hd-about").html().replace(/<br>/g,""),d=_dialog({width:420,head:"Редактирование содержания напоминания",content:'<table id="_remind-head-edit"><tr><td class="label">Задача:<td><input type="text" id="hdtxt" value="'+f+'" /><tr><td class="label top">Подробно:<td><textarea id="hd-about">'+a+"</textarea></table>",butSubmit:"Сохранить",submit:b});$("#hdtxt").focus().keyEnter(b);$("#hd-about").autosize()}).on("click","._remind-unit .ruhist",
function(){$(this).parent().next().slideToggle(300)}).on("click","#_remind-next",function(){var b=$(this),a=remindFilter();a.page=$(this).attr("val");b.hasClass("busy")||(b.addClass("busy"),$.post(AJAX_MAIN,a,function(a){a.success?b.after(a.html).remove():b.removeClass("busy")},"json"))}).on("click","#_remind-show-all",function(){$("._remind-unit").slideDown(200);$(this).remove()}).ready(function(){$("#_remind-status").length&&$("#_remind-status")._radio(remindSpisok)});
