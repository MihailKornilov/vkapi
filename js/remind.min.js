var _remindAdd=function(){var b=_dialog({top:40,width:480,head:"Внесение нового напоминания",content:'<table class="_remind-add-tab">'+(window.ZI?'<tr><td class="label">Заявка:<td><b>'+ZI.name+"</b>":"")+(window.CLIENT?'<tr><td class="label">Клиент:<td>'+CLIENT.fio:"")+'<tr><td class="label">Задача:<td><input type="text" id="txt" /><tr><td class="label top">Подробно:<td><textarea id="about"></textarea><tr><td class="label">День выполнения:<td><input type="hidden" id="day" /></table><input type="hidden" id="client_id" value="'+
(window.CLIENT?CLIENT.id:0)+'"><input type="hidden" id="zayav_id" value="'+(window.ZI?ZI.id:0)+'">',submit:function(){var a={op:"remind_add",client_id:$("#client_id").val(),zayav_id:$("#zayav_id").val(),txt:$.trim($("#txt").val()),about:$("#about").val(),day:$("#day").val()};a.txt?(b.process(),$.post(AJAX_MAIN,a,function(a){a.success?(b.close(),_msg(),_remindSpisok()):b.abort()},"json")):(b.err("Не указано содержание задачи"),$("#txt").focus())}});$("#txt").focus();$("#about").autosize();$("#day")._calendar();
return!1},_remindSpisok=function(b,a){_filterSpisok(REMIND,b,a);$.post(AJAX_MAIN,REMIND,function(a){a.success&&$("#_remind-spisok").html(a.spisok)},"json")};
$(document).on("click","._remind-add",_remindAdd).on("click","._remind-unit .action",function(){function b(a){var b={op:"remind_action",from:window.ZI?"zayav":window.CLIENT?"client":"",id:f,status:a,day:$("#remind_day").val(),reason:$("#reason")._select("inp")};1==a&&b.day==d?c.err("Выберите другой день"):1!=a||b.reason?$.post(AJAX_MAIN,b,function(a){a.success&&(c.close(),_msg(),_remindSpisok())},"json"):c.err("Не указана причина")}for(var a=$(this);!a.hasClass("_remind-unit");)a=a.parent();var f=
a.attr("val"),e=a.find(".hdtxt").html(),d=a.find(".ruday").val(),c=_dialog({top:30,head:"Изменение статуса напоминания",content:'<div id="_remind-action-tab"><div id="hd">'+e+'</div><div class="st c1" val="1">Указать другой день<div class="about">Перенести напоминание на другой день.</div></div><div class="st c2" val="2">Выполнено<div class="about">Задание выполнено успешно.</div></div><div class="st c3" val="3">Отмена<div class="about">Отмена напоминания по какой-либо причине.</div></div><table id="ra-tab"><tr><td class="label">Новый день:<td><input type="hidden" id="remind_day" value="'+
d+'" /><tr><td class="label">Причина:<td><input type="hidden" id="reason" /></table></div>',butSubmit:"",butCancel:"Закрыть",submit:function(){b(1)}});$("#remind_day")._calendar();$("#reason")._select({width:225,spisok:[],write:!0});$("#reason")._select("process");$.post(AJAX_MAIN,{op:"remind_reason_spisok"},function(a){$("#reason")._select("cancel");a.success&&$("#reason")._select(a.spisok)},"json");$(".st").click(function(){var a=$(this).attr("val");1==a?($(".c2,.c3").hide(),$("#ra-tab").show(),
c.butSubmit("Применить")):($("#_remind-action-tab").addClass("busy"),b(a))})}).on("click","._remind-unit .hd-edit",function(){function b(){var a={op:"remind_head_edit",id:f,txt:$("#hdtxt").val(),about:$("#hd-about").val()};a.txt?(c.process(),$.post(AJAX_MAIN,a,function(b){b.success?(c.close(),_msg(),e.html(a.txt),d.html(a.about.replace(/\n/g,"<br>"))):c.abort()},"json")):(c.err("Не указано содержание задачи"),e.focus())}var a=$(this),a=_parent(a,"._remind-unit"),f=a.attr("val"),e=a.find(".hdtxt"),
d=a.find(".hd-about"),a='<table id="_remind-head-edit"><tr><td class="label">Задача:<td><input type="text" id="hdtxt" value="'+e.html()+'" /><tr><td class="label top">Подробно:<td><textarea id="hd-about">'+d.html().replace(/<br>/g,"")+"</textarea></table>",c=_dialog({width:420,head:"Редактирование содержания напоминания",content:a,butSubmit:"Сохранить",submit:b});$("#hdtxt").focus().keyEnter(b);$("#hd-about").autosize()}).on("click","._remind-unit .ruhist",function(){$(this).parent().next().slideToggle(300)}).on("click",
"#_remind-show-all",function(){$("._remind-unit").slideDown(200);$(this).remove()}).ready(function(){$("#report.remind").length&&$("#status")._radio(_remindSpisok)});
