var _remindAdd=function(){var a=_dialog({top:40,width:480,head:"Внесение нового напоминания",content:'<table class="_remind-add-tab">'+(window.ZI?'<tr><td class="label">Заявка:<td><b>'+ZI.name+"</b>":"")+(window.CI?'<tr><td class="label">Клиент:<td>'+CI.fio:"")+'<tr><td class="label">Задача:<td><input type="text" id="txt" /><tr><td class="label top">Подробно:<td><textarea id="about"></textarea><tr><td class="label">День выполнения:<td><input type="hidden" id="day" /></table><input type="hidden" id="client_id" value="'+
(window.CI?CI.id:0)+'"><input type="hidden" id="zayav_id" value="'+(window.ZI?ZI.id:0)+'">',submit:function(){var b={op:"remind_add",client_id:$("#client_id").val(),zayav_id:$("#zayav_id").val(),txt:$.trim($("#txt").val()),about:$("#about").val(),day:$("#day").val()};b.txt?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg(),window.ZI&&!window.REMIND?location.reload():_remindSpisok()):a.abort()},"json")):(a.err("Не указано содержание задачи"),$("#txt").focus())}});$("#txt").focus();
$("#about").autosize();$("#day")._calendar();return!1},_remindSpisok=function(a,b){_filterSpisok(REMIND,a,b);$.post(AJAX_MAIN,REMIND,function(a){a.success&&$("#_remind-spisok").html(a.spisok)},"json")};
$(document).on("click","._remind-add",_remindAdd).on("click","._remind-unit .action",function(){function a(a){var b={op:"remind_action",from:window.ZI?"zayav":window.CI?"client":"",id:d,status:a,day:$("#remind_day").val(),reason:$("#reason")._select("inp")};1==a&&b.day==c?e.err("Выберите другой день"):1!=a||b.reason?$.post(AJAX_MAIN,b,function(a){a.success&&(e.close(),_msg(),_remindSpisok())},"json"):e.err("Не указана причина")}for(var b=$(this);!b.hasClass("_remind-unit");)b=b.parent();var d=b.attr("val"),
f=b.find(".hdtxt").html(),c=b.find(".ruday").val(),e=_dialog({top:30,head:"Изменение статуса напоминания",content:'<div id="_remind-action-tab"><div id="hd">'+f+'</div><div class="st c1" val="1">Указать другой день<div class="about">Перенести напоминание на другой день.</div></div><div class="st c2" val="2">Выполнено<div class="about">Задание выполнено успешно.</div></div><div class="st c3" val="3">Отмена<div class="about">Отмена напоминания по какой-либо причине.</div></div><table id="ra-tab"><tr><td class="label">Новый день:<td><input type="hidden" id="remind_day" value="'+
c+'" /><tr><td class="label">Причина:<td><input type="hidden" id="reason" /></table></div>',butSubmit:"",butCancel:"Закрыть",submit:function(){a(1)}});$("#remind_day")._calendar();$("#reason")._select({width:225,spisok:[],write:1,write_save:1});$("#reason")._select("process");$.post(AJAX_MAIN,{op:"remind_reason_spisok"},function(a){$("#reason")._select("cancel");a.success&&$("#reason")._select(a.spisok)},"json");$(".st").click(function(){var b=$(this).attr("val");1==b?($(".c2,.c3").hide(),$("#ra-tab").show(),
e.butSubmit("Применить")):($("#_remind-action-tab").addClass("busy"),a(b))})}).on("click","._remind-unit .hd-edit",function(){var a=$(this),a=_parent(a,"._remind-unit"),b=a.attr("val"),d=a.find(".hdtxt"),f=a.find(".hd-about"),a='<table id="_remind-head-edit"><tr><td class="label">Задача:<td><input type="text" id="hdtxt" value="'+d.html()+'" /><tr><td class="label top">Подробно:<td><textarea id="hd-about">'+f.html().replace(/<br>/g,"")+"</textarea></table>",c=_dialog({width:420,head:"Редактирование содержания напоминания",
content:a,butSubmit:"Сохранить",submit:function(){var a={op:"remind_head_edit",id:b,txt:$("#hdtxt").val(),about:$("#hd-about").val()};a.txt?(c.process(),$.post(AJAX_MAIN,a,function(b){b.success?(c.close(),_msg(),d.html(a.txt),f.html(a.about.replace(/\n/g,"<br>"))):c.abort()},"json")):(c.err("Не указано содержание задачи"),d.focus())}});$("#hdtxt").focus();$("#hd-about").autosize()}).on("click","._remind-unit .ruhist",function(){$(this).parent().next().slideToggle(300)}).on("click","#_remind-show-all",
function(){$("._remind-unit").slideDown(200);$(this).remove()}).ready(function(){$("#report.remind").length&&$("#status")._radio(_remindSpisok)});
