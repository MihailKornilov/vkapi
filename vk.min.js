var VK_SCROLL=0,ZINDEX=0,BC=0,FB,FH,FB_HEIGHT=0,DIALOG_MAXHEIGHT=0,FOTO_HEIGHT=0,REGEXP_NUMERIC=/^\d+$/,REGEXP_CENA=/^[\d]+(.[\d]{1,2})?(,[\d]{1,2})?$/,REGEXP_DATE=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,MONTH_DEF={1:"Январь",2:"Февраль",3:"Март",4:"Апрель",5:"Май",6:"Июнь",7:"Июль",8:"Август",9:"Сентябрь",10:"Октябрь",11:"Ноябрь",12:"Декабрь"},MONTH_DAT={1:"января",2:"февраля",3:"марта",4:"апреля",5:"мая",6:"июня",7:"июля",8:"августа",9:"сентября",10:"октября",11:"ноября",12:"декабря"},SITE="http://"+DOMAIN,
URL=SITE+"/index.php?"+VALUES,AJAX_MAIN=SITE+"/ajax/main.php?"+VALUES,setCookie=function(a,c){var b=new Date;b.setDate(b.getDate()+1);document.cookie=a+"="+c+"; path=/; expires="+b.toGMTString()},getCookie=function(a){a=document.cookie.split(a);return 1<a.length?(a=a[1].split(/;/)[0].split(/=/),a[0]?a[0]:a[1]):null},delCookie=function(a){var c=new Date;c.setDate(c.getDate()-1);document.cookie=a+"=; path=/; expires="+c.toGMTString()},sortable=function(){$("._sort").sortable({axis:"y",update:function(){for(var a=
$(this).find("dd"),c=[],b=0;b<a.length;b++)c.push(a.eq(b).attr("val"));a={op:"sort",table:$(this).attr("val"),ids:c.join()};$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,a,function(a){$("#mainLinks").removeClass("busy")},"json")}})},imageSortable=function(){$("._image-spisok").sortable({update:function(){for(var a=$(this).find("a"),c=[],b=0;b<a.length;b++)c.push(a.eq(b).attr("val"));a={op:"image_sort",ids:c.join()};$.post(AJAX_MAIN,a)}})},_end=function(a,c){2==c.length&&c.push(c[1]);var b=c[2];
if(1!=Math.floor(a/10%10))switch(a%10){case 1:b=c[0];break;case 2:b=c[1];break;case 3:b=c[1];break;case 4:b=c[1]}return b},_fbhs=function(){var a;0<FOTO_HEIGHT?(a=FOTO_HEIGHT,FB.height(a)):(0==DIALOG_MAXHEIGHT&&FB.height("auto"),a=FB.height(),a<DIALOG_MAXHEIGHT&&(a=DIALOG_MAXHEIGHT,FB.height(a)));FB_HEIGHT!=a&&(FB_HEIGHT=a,VK.callMethod("resizeWindow",625,a))},_backfon=function(a){void 0===a&&(a=!0);var c=$("body");a?(ZINDEX+=10,0==BC&&c.find("._backfon").remove().end().append('<div class="_backfon"></div>'),
c.find("._backfon").css({"z-index":ZINDEX}),BC++):(BC--,ZINDEX-=10,0==BC?c.find("._backfon").remove():c.find("._backfon").css({"z-index":ZINDEX}))},_msg=function(a){var c=$("#_msg");0<c.length&&c.remove();$("body").append("<div id=_msg>"+a+"</div>");$("#_msg").css("top",$(this).scrollTop()+200+VK_SCROLL).delay(1200).fadeOut(400,function(){$(this).remove()})},_dialog=function(a){function c(){e.remove();_backfon(!1);0==b&&(DIALOG_MAXHEIGHT=0);_fbhs()}$(this).attr("id");a=$.extend({width:360,top:100,
head:"head: Название заголовка",load:0,content:"content: содержимое центрального поля",submit:function(){},cancel:function(){},butSubmit:"Внести",butCancel:"Отмена"},a);a.load&&(a.content='<div class="load _busy"><div class="ms">В процессе загрузки произошла ошибка.</div></div>');var b=$(".dFrame").length,d='<div class="_dialog"><div class="head"><div><A class="img_del"></A>'+a.head+'</div></div><div class="dcntr"><iframe class="dFrame" name="dFrame'+b+'"></iframe><div class="content">'+a.content+
'</div></div><div class="bottom">'+(a.butSubmit?'<div class="vkButton"><button>'+a.butSubmit+"</button></div>":"")+(a.butCancel?'<div class="vkCancel"><button>'+a.butCancel+"</button></div>":"")+"</div></div>";0==b&&(DIALOG_MAXHEIGHT=0);var e=$("body").append(d).find("._dialog:last"),d=e.find(".content"),k=e.find(".bottom"),g=k.find(".vkButton");e.find(".head .img_del").click(c);g.find("button").click(a.submit);k.find(".vkCancel").click(function(){a.cancel();c()});_backfon();e.css({width:a.width+
"px",top:$(window).scrollTop()+VK_SCROLL+a.top+"px",left:313-Math.round(a.width/2)+"px","z-index":ZINDEX+5});window["dFrame"+b].onresize=function(){for(var a=$(".dFrame"),b=0,c=0;c<a.length;c++){var d=a.eq(c).height();d>b&&(b=d)}a=b+VK_SCROLL+80;DIALOG_MAXHEIGHT!=a&&(DIALOG_MAXHEIGHT=a,_fbhs())};return{close:c,process:function(){g.addClass("_busy")},abort:function(){g.removeClass("_busy")},bottom:k,content:d,loadError:function(){e.find(".load").removeClass("_busy")}}},_tooltip=function(a,c,b){return' _tooltip"><div class="ttdiv"'+
(c?' style="left:'+c+'px"':"")+'><div class="ttmsg">'+a+'</div><div class="ttug'+(b?" "+b:"")+'"></div></div>'};
$.fn.fotoUpload=function(a){function c(){var a=getCookie("fotoUpload");if("process"!=a)switch(f&&f.close(),l.html("Выберите файл"),clearInterval(n),a=a.split("_"),a[0]){case "uploaded":a=getCookie("fotoParam").split("_");b(a[0].replace(/%3A/,":").replace(/%2F/g,"/"),a[1],a[2]);break;case "error":d(a[1])}}function b(b,c,d){g.close();_msg("Изображение успешно загружено!");window.fotoViewImages=!1;b={link:b,x:c,y:d,dtime:"сегодня"};a.max_x&&c>a.max_x&&(c=a.max_x,d=Math.round(b.y/b.x*a.max_x));a.max_y&&
d>a.max_y&&(d=a.max_y,c=Math.round(b.x/b.y*a.max_y));b.img='<IMG src="'+b.link+'-big.jpg" width="'+c+'" height="'+d+'">';a.func(b)}function d(a){$("#error_msg").remove();var b="не известна";1==a&&(b="неверный формат файла");2==a&&(b="слишком маленький размер изображения.<BR>Допустимый размер не менее 100x100 px");$("#fotoUpload .webcam").after('<div id="error_msg">Не удалось загрузить изображение.<BR>Причина: '+b+".</div>")}function e(){if(!m.hasClass("busy")){var a=h.val();a&&(a={op:"link",link:a},
m.addClass("busy"),$.post(IMAGE_UPLOAD_PATH,a,function(a){m.removeClass("busy");a.error?d(a.error):b(a.link,a.x,a.y)},"json"))}}function k(){f=_dialog({top:20,width:610,head:"Создание снимка с вебкамеры",content:'<div id="screen"></div>',butSubmit:"Сделать снимок",butCancel:"Закрыть",submit:function(){f.process();setCookie("fotoUpload","process");n=setInterval(c,500);document.getElementById("webcam_movie")._snap(IMAGE_UPLOAD_PATH,100,0,0)}});f.content.css({padding:0,height:"457px"});p.screen=$("#screen");
p.show(608,457);f.content.resizable({minWidth:322,maxWidth:608,minHeight:240,maxHeight:457,resize:function(a,b){var c=b.size.width,d=b.originalSize.width-c;0!=d&&(c-=d,322>c&&(c=322),608<c&&(c=608),b.size.width=c,f.content.parent().css({left:313-Math.round(b.size.width/2)+"px",width:c+"px"}),$(this).width("auto"))},start:function(){p.reset()},stop:function(){var a=f.content.height(),b=f.content.width();p.screen.height(a);p.show(b,a)}})}a=$.extend({owner:!1,func:function(){}},a);if(!a.owner)throw Error("Не указан владелец изображения - <b>owner</b>");
IMAGE_UPLOAD_PATH+="?"+VALUES+"&owner="+a.owner;var g,f,n,l,h,m,p={screen:null,show:function(a,b){},reset:function(){}};$(this).on("click",function(){g=_dialog({top:80,head:"Загрузка изображения",content:'<div id="fotoUpload"><div class="info">Поддерживаются форматы JPG, PNG и GIF.</div><FORM method="post" action="'+IMAGE_UPLOAD_PATH+'" enctype="multipart/form-data" target="upload_frame"><INPUT type="file" id="file_name" name="file_name" /><INPUT type="hidden" name="op" value="file" /></FORM><div id="choose_file">Выберите файл</div><IFRAME name="upload_frame"></IFRAME><div id="direct"><INPUT type="text" id="direct_input" placeholder="или укажите прямую ссылку на изображение.."><a><span>oтправить</span></a></div><div class="webcam">Вы также можете <A>сделать фотографию с вебкамеры »</A></div></div>',
butSubmit:null,butCancel:"Закрыть"});var a=$("#fotoUpload form"),b=$("#file_name");l=$("#choose_file");h=$("#direct_input");m=h.next();if(/MSIE/.test(window.navigator.userAgent))b.on({mouseenter:function(){l.css("background-color","#e9edf1")},mouseleave:function(){l.css("background-color","#eff1f3")}});else l.addClass("no_msie").on("click",function(){b.click()}),a.hide();b.change(function(){l.html("&nbsp;<IMG src=/img/upload.gif>");setCookie("fotoUpload","process");n=setInterval(c,500);a.submit()});
h.keyEnter(e);m.click(e);$("#fotoUpload .webcam a").click(k)})};
$.fn._check=function(a){function c(a){$(document).on("click","#"+d+"_check",function(){a(parseInt(b.val()),d)})}var b=$(this),d=b.attr("id");switch(typeof a){case "number":case "string":case "boolean":a=1==a?1:0;if(b.val()==a)return b;b.val(a);b.parent().removeClass("check"+(1==a?0:1)).addClass("check"+a);return b;case "function":return c(a),b}a=$.extend({name:"",func:function(){}},a);var e=1==b.val()?1:0;b.val(e);b.wrap('<div class="_check check'+e+(a.name?"":" e")+'" id="'+d+'_check">');b.after(a.name);
c(a.func);return b};
$.fn._radio=function(a){function c(a){$(document).on("click","#"+e+"_radio",function(){a(parseInt(b.val()),e)})}var b=$(this),d,e=b.attr("id");switch(typeof a){case "number":case "string":d=b.parent();if(d.hasClass("_radio")){d.find(".on").removeClass("on").addClass("off");var k=d.find("div");for(d=0;d<k.length;d++){var g=k.eq(d);if(a==g.attr("val")){g.addClass("on").removeClass("off");break}}b.val(a)}return b;case "function":return c(a),b}a=$.extend({title0:"",spisok:[],light:0,func:function(){}},
a);var k="",g=b.val(),f=[];a.title0&&(f=[{uid:0,title:a.title0}]);for(d=0;d<a.spisok.length;d++)f.push(a.spisok[d]);for(d=0;d<f.length;d++)var n=f[d],k=k+('<div class="'+(g==n.uid?"on":"off")+(a.light?" l":"")+'" val="'+n.uid+'"><s></s>'+n.title+"</div>");b.wrap('<div class="_radio" id="'+e+'_radio">');b.after(k);c(a.func);return b};
$.fn._search=function(a){function c(){g.css("color","#ccc")}var b=$(this),d=b.attr("id");switch(typeof a){case "number":case "string":if("val"==a)return window[d+"_search"].inp();"clear"==a&&window[d+"_search"].clear();return b}a=$.extend({width:126,focus:0,txt:"",func:function(){},enter:0},a);b.html('<div class="_search" style="width:'+a.width+'px"><div class="img_del dn"></div><div class="hold">'+a.txt+'</div><input type="text" style="width:'+(a.width-45)+'px" /></div>');var e=b.find("._search"),
k=b.find("input"),g=b.find(".hold"),f=b.find(".img_del");a.focus&&(k.focus(),c());k.focus(c).blur(function(){g.css("color","#777")}).keyup(function(){var b=0<$(this).val().length;g[(b?"add":"remove")+"Class"]("dn");f[(b?"remove":"add")+"Class"]("dn");a.enter||a.func(k.val(),d)});a.enter&&k.keydown(function(b){13==b.which&&a.func($(this).val(),d)});b.clear=function(){k.val("");f.addClass("dn");g.removeClass("dn")};f.click(function(){b.clear();a.func("",d)});e.click(function(){k.focus();c()});b.inp=
function(a){if(!a)return $.trim(k.val());k.val(a);f.removeClass("dn");g.addClass("dn");return $(this)};b.clear=function(){k.val("");f.addClass("dn");g.removeClass("dn")};return window[d+"_search"]=b};
$.fn._calendar=function(a){function c(){var c,d="<tr>",e=l.getFullYear(),g=l.getMonth()+1,k=l.getDate(),f;f=(new Date(a.year,a.mon-1,1)).getDay();f=0==f?7:f;var n=e==a.year&&g==a.mon,r=0==a.lost,t=a.year==h&&a.mon==m,s;c=a.year;s=a.mon;s--;0==s&&(s=12,c--);s=32-(new Date(c,s,32)).getDate();if(1<f)for(c=0;c<f-1;c++)d+="<td>";for(c=1;c<=s;c++){var u="";a.year<e?u=" lost":a.year==e&&a.mon<g?u=" lost":a.year==e&&a.mon==g&&c<k&&(u=" lost");d+='<td class="'+(!u||u&&!r?" sel":"")+(n&&c==k?" b":"")+(t&&c==
p?" set":"")+u+'"'+(!u||u&&!r?' val="'+c+'"':"")+">"+c;f++;8==f&&c!=s&&(d+="<tr>",f=1)}q.html(d).find(".sel").click(b)}function b(){h=a.year;m=a.mon;p=$(this).attr("val");t.html(p+" "+MONTH_DAT[m]+" "+h);g.val(d());a.func(d())}function d(){return h+"-"+(10>m?"0":"")+m+"-"+(10>p?"0":"")+p}function e(b){b.stopPropagation();a.mon--;0==a.mon&&(a.mon=12,a.year--);s.html(MONTH_DEF[a.mon]+" "+a.year);c()}function k(b){b.stopPropagation();a.mon++;13==a.mon&&(a.mon=1,a.year++);s.html(MONTH_DEF[a.mon]+" "+
a.year);c()}var g=$(this),f=g.attr("id"),n=g.val(),l=new Date;a=$.extend({year:l.getFullYear(),mon:l.getMonth()+1,day:l.getDate(),lost:0,func:function(){},place:"right"},a);REGEXP_DATE.test(n)&&(n=n.split("-"),a.year=n[0],a.mon=Math.abs(n[1]),a.day=Math.abs(n[2]));g.wrap('<div class="_calendar" id="'+f+'_calendar">');g.after('<div class="calinp">'+a.day+" "+MONTH_DAT[a.mon]+" "+a.year+'</div><div class="calabs"></div>');var h=a.year,m=a.mon,p=a.day,t=g.next(),r=t.next(),s,q;g.val(d());t.click(function(b){if(!r.html()){b.stopPropagation();
b=$(".calabs");for(var d=0;d<b.length;d++){var g=b.eq(d);g.parent().attr("id").split("_calendar")[0]!=f&&g.html("")}$(document).on("click.calendar"+f,function(){r.html("");$(document).off("click.calendar"+f)});a.year=h;a.mon=m;a.day=p;r.html('<div class="calcal" style="left:'+("right"==a.place?0:-64)+'px"><table class="calhead"><tr><td class="calback"><td class="calmon">'+MONTH_DEF[m]+" "+h+'<td class="calnext"></table><table class="calweeks"><tr><td>Пн<td>Вт<td>Ср<td>Чт<td>Пт<td>Сб<td>Вс</table><table class="caldays"></table></div>');
r.find(".calback").click(e);r.find(".calnext").click(k);s=r.find(".calmon");q=r.find(".caldays");c()}})};
$.fn.years=function(a){var c=$(this),b=c.attr("id");if(b){a=$.extend({year:(new Date).getFullYear(),start:function(){},func:function(){},center:function(){}},a);c.after('<div class="years" id="years_'+b+'"><TABLE><TR><TD class="but">&laquo;<TD id="ycenter"><SPAN>'+a.year+'</SPAN><TD class="but">&raquo;</TABLE></div>');c.val(a.year);var d={left:0,speed:2,span:$("#years_"+b+" #ycenter SPAN"),width:Math.round($("#years_"+b+" #ycenter").css("width").split(/px/)[0]/2),ismove:0,next:function(e){a.start();
if(0==d.ismove){d.ismove=1;var k=0,g=setInterval(function(){var f=d.span;d.left-=d.speed*e;if(0<d.left&&1==k&&-1==e||0>d.left&&1==k&&1==e)d.left=0,d.ismove=0,d.speed=0,clearInterval(g);f[0].style.left=d.left+"px";d.speed+=2;if(d.left>d.width&&0==k&&-1==e||d.left<-d.width&&0==k&&1==e)k=1,a.year+=e,f.html(a.year),d.left=d.width*e,c.val(a.year),a.func(a.year,b)},25)}}};$("#years_"+b+" #ycenter").click(a.center);$("#years_"+b+" .but:first").mousedown(function(){allmon=1;d.next(-1)});$("#years_"+b+" .but:eq(1)").mousedown(function(){allmon=
1;d.next(1)})}};$.fn.keyEnter=function(a){$(this).keydown(function(c){13==c.keyCode&&a()});return $(this)};
$.fn.rightLink=function(a){function c(a,b){var c=a.parent();c.find("a").click(function(){c.find(".sel").removeClass("sel");$(this).addClass("sel");var e=$(this).attr("val");a.val(e);b(e,d)})}var b=$(this),d=b.attr("id"),e;if("number"==typeof a||"string"==typeof a){e=b.parent();if(e.hasClass("rightLink")){e.find(".sel").removeClass("sel");var k=e.find("a");for(e=0;e<k.length;e++){var g=k.eq(e);if(a==g.attr("val")){g.addClass("sel");break}}b.val(a)}return b}if("function"==typeof a)return c(b,a),b;a=
$.extend({spisok:[],func:function(){}},a);k="";g=b.val();for(e=0;e<a.spisok.length;e++)var f=a.spisok[e],k=k+("<a "+(g==f.uid?'class="sel"':"")+' val="'+f.uid+'">'+f.title+"</a>");b.wrap('<div class="rightLink">');b.after(k);c(b,a.func);return b};
$.fn._dropdown=function(a){function c(c){b();a.nosel||(d.val(c),t.html(f[c])[(a.title0&&!c?"add":"remove")+"Class"]("grey"),s.html(f[c]))}function b(){m&&(clearTimeout(m),m=0)}var d=$(this),e=d.attr("id");if("number"==typeof a||"string"==typeof a){switch(a){case "remove":d.next().remove("._dropdown");break;default:window[e+"_dropdown"].value(a)}return d}a=$.extend({head:"",headgrey:0,title0:"",spisok:[],func:function(){},nosel:0},a);var k,g=1*d.val()||0,f=function(){for(var b=a.title0?{0:a.title0}:
{},c=0;c<a.spisok.length;c++){var d=a.spisok[c];b[d.uid]=d.title}return b}(),n=a.head||a.title0,l=a.spisok.length,h=a.title0?'<a class="ddu grey'+(l?"":" last")+(g?"":" seld")+'" val="0">'+a.title0+"</a>":"",m=0;d.val(g);for(k=0;k<l;k++){var p=a.spisok[k],h=h+('<a class="ddu'+(k==l-1?" last":"")+(g==p.uid?" seld":"")+'" val="'+p.uid+'">'+p.title+"</a>");g==p.uid&&(n=p.title)}d.next().remove("._dropdown");d.after('<div class="_dropdown" id="'+e+'_dropdown"><a class="ddhead'+(g||!a.headgrey&&!a.title0?
"":" grey")+'">'+n+'</a><div class="ddlist"><div class="ddsel">'+n+"</div>"+h+"</div></div>");var g=d.next(),t=g.find(".ddhead"),r=g.find(".ddlist"),s=r.find(".ddsel"),q=r.find(".ddu");t.click(function(){b();r.show()});s.click(function(){b();r.hide()});q.click(function(){var b=$(this),d=parseInt(b.attr("val"));c(d);a.nosel||b.addClass("seld");r.hide();a.func(d,e)}).mouseenter(function(){q.removeClass("seld")});r.on({mouseleave:function(){m=setTimeout(function(){r.fadeOut(200)},500)},mouseenter:b});
d.value=function(a){c(a);r.find(".seld").removeClass("seld");for(k=0;k<q.length;k++){var b=q.eq(k);if(b.attr("val")==a){b.addClass("seld");break}}};return window[e+"_dropdown"]=d};
(function(){var a=function(a,b){this.create(a,b);return a};a.prototype.create=function(a,b){function d(){function a(){m="showing";f.css({top:b.top,left:b.left}).animate({top:l,left:h,opacity:"show"},200,c)}function c(){m="show";if(0!=b.correct)$(document).on("keydown.hint",function(a){a.preventDefault();switch(a.keyCode){case 38:b.top--;l--;break;case 40:b.top++;l++;break;case 37:b.left--;h--;break;case 39:b.left++,h++}f.css({top:l,left:h});f.find("#correct_top").html(b.top);f.find("#correct_left").html(b.left)})}
0!=b.correct&&$(document).off("keydown.hint");switch(m){case "wait_to_hidding":clearTimeout(p);m="show";break;case "hidding":m="showing";f.stop().animate({top:l,left:h,opacity:1},200,c);break;case "hidden":0<b.delayShow?(m="wait_to_showing",p=setTimeout(a,b.delayShow)):a()}}function e(){function d(){m="hidding";f.animate({opacity:"hide"},200,function(){m="hidden";0!=b.remove&&(g.remove(),a.off(b.event+".hint"),a.off("mouseleave.hint"))})}0!=b.correct&&$(document).off("keydown.hint");"wait_to_showing"==
m&&(clearTimeout(p),m="hidden");"showing"==m&&(f.stop(),d());"show"==m&&(0<b.delayHide?(m="wait_to_hidding",p=setTimeout(d,b.delayHide)):d())}b=$.extend({msg:"Сообщение подсказки",width:0,event:"mouseenter",ugol:"bottom",indent:"center",top:0,left:0,show:0,delayShow:0,delayHide:0,correct:0,remove:0},b);var k="<TABLE class=cont_table><TR><TD class=ugttd colspan=3>"+("top"==b.ugol?"<div class=ugt></div>":"")+"<TR><TD class=ugltd>"+("left"==b.ugol?"<div class=ugl></div>":"")+"<TD class=cont>"+(1==b.correct?
"<div class=correct>top: <SPAN id=correct_top>"+b.top+"</SPAN> left: <SPAN id=correct_left>"+b.left+"</SPAN></div>":"")+b.msg+"<TD class=ugrtd>"+("right"==b.ugol?"<div class=ugr></div>":"")+"<TR><TD class=ugbtd colspan=3>"+("bottom"==b.ugol?"<div class=ugb></div>":"")+"</TABLE>",k="<TABLE class=hint_table><TR><TD class=side005><TD>"+("<TABLE><TR><TD class=side012><TD>"+k+"<TD class=side012><TR><TD class=b012 colspan=3></TABLE>")+"<TD class=side005><TR><TD class=b005 colspan=3></TABLE>";a.prev().remove(".hint");
a.before("<div class=hint>"+k+"</div>");var g=a.prev(),f=g.find(".hint_table:first");0<b.width&&f.find(".cont_table:first").width(b.width);var k=f.width(),n=f.height();f.hide().css("visibility","visible");var l=b.top,h=b.left;switch(b.ugol){case "top":l=b.top-15;n=f.find(".ugttd:first");"center"==b.indent?n.css("text-align","center"):"right"==b.indent?n.css("text-align","right"):"left"==b.indent?n.css("text-align","left"):isNaN(b.indent)||(n.css("text-align","left"),10>b.indent&&(b.indent=10),b.indent>
k&&(b.indent=k-28),f.find(".ugt:first").css("margin-left",b.indent+"px"));break;case "right":h=b.left+25;k=f.find(".ugrtd:first");"center"==b.indent?k.css("vertical-align","middle"):"bottom"==b.indent?k.css("vertical-align","bottom"):isNaN(b.indent)||(3>b.indent&&(b.indent=3),b.indent>n&&(b.indent=n-31),f.find(".ugr:first").css("margin-top",b.indent+"px"));break;case "bottom":l=b.top+15;n=f.find(".ugbtd:first");"center"==b.indent?n.css("text-align","center"):"right"==b.indent?n.css("text-align","right"):
"left"==b.indent?n.css("text-align","left"):isNaN(b.indent)||(n.css("text-align","left"),10>b.indent&&(b.indent=10),b.indent>k&&(b.indent=k-28),f.find(".ugb:first").css("margin-left",b.indent+"px"));break;case "left":h=b.left-25,k=f.find(".ugltd:first"),"center"==b.indent?k.css("vertical-align","middle"):"bottom"==b.indent?k.css("vertical-align","bottom"):isNaN(b.indent)||(3>b.indent&&(b.indent=3),b.indent>n&&(b.indent=n-31),f.find(".ugl:first").css("margin-top",b.indent+"px"))}a.off(b.event+".hint");
a.off("mouseleave.hint");a.on(b.event+".hint",d);a.on("mouseleave.hint",e);f.on("mouseenter.hint",d);f.on("mouseleave.hint",e);var m="hidden",p=0;0!=b.show&&d()};$.fn.vkHint=function(c){return new a($(this),c)}})();
$.fn._select=function(a){function c(){if(a.spisok.length){if(a.write){var b=q.val();if(b.length){var c=[];reg=RegExp(b,"i");for(h=0;h<a.spisok.length;h++){for(var b=a.spisok[h],d=b.content.split(D),e=0;e<d.length;e++){var g=d[e];if(g.length&&!D.test(g)&&reg.test(g)){d[e]=g.replace(reg,"<em>$&</em>");b.content=d.join("");c.push(b);break}}if(a.limit&&c.length==a.limit)break}a.spisok=c}}c=a.title0&&!a.write?'<div class="selun title0" val="0">'+a.title0+"</div>":"";b=a.spisok.length;a.limit&&b>a.limit&&
(b=a.limit);for(h=0;h<b;h++)d=a.spisok[h],B[d.uid]||(c+='<div class="selun" val="'+d.uid+'">'+(d.content||d.title)+"</div>");v.removeClass("h250").html(c).find(".selun:last").addClass("last");x=v.height();250<x&&v.addClass("h250")}else v.html('<div class="nofind">'+a.nofind+"</div>").removeClass("h250")}function b(a){if(E[a.keyCode]){a.preventDefault();var b=v.find(".selun"),c=v[0],d=b.length;for(h=0;h<d&&!b.eq(h).hasClass("ov");h++);switch(a.keyCode){case 38:h==d&&(h=1);0<h?(1<d&&b.eq(h).removeClass("ov"),
a=b.eq(h-1)):a=b.eq(0);a.addClass("ov");a=a[0];c.scrollTop>a.offsetTop&&(c.scrollTop=a.offsetTop);0<a.offsetTop-250-c.scrollTop+a.offsetHeight&&(c.scrollTop=a.offsetTop-250+a.offsetHeight);break;case 40:h==d&&(b.eq(0).addClass("ov"),c.scrollTop=0);h<d-1&&(b.eq(h).removeClass("ov"),a=b.eq(h+1),a.addClass("ov"),a=a[0],250<a.offsetTop+a.offsetHeight-c.scrollTop&&(c.scrollTop=a.offsetTop+a.offsetHeight-250),a.offsetTop<c.scrollTop&&(c.scrollTop=a.offsetTop));break;case 13:h<d&&(q.blur(),k(b.eq(h)),n());
break;case 27:case 9:q.blur(),n()}}}function d(){w=a.title0?{0:""}:{};for(h=0;h<a.spisok.length;h++){var b=a.spisok[h];w[b.uid]=b.title;b.content||(b.content=b.title);A.push({uid:b.uid,title:b.title,content:b.content})}}function e(b){if(a.multiselect)if(z){b=C.find(".x");var c=[];for(h=0;h<b.length;h++)c.push(b.eq(h).attr("val"));l.val(c.join())}else l.val(0);else t=b,l.val(b),q.val(w[b]),y[0==b?"show":"hide"]()}function k(b){b=parseInt(b.attr("val"));var c;a.multiselect&&((!a.title0&&!b||0<b)&&q.before('<div class="multi">'+
w[b]+'<span class="x" val="'+b+'"></span></div>'),g(b,!0));e(b);for(h=0;h<a.spisok.length;h++){var d=a.spisok[h];if(d.uid==b){c=d;break}}a.func(b,p,c);u=q.val()}function g(b,d){var e=C.find(".multi"),g=0;z=e.length;for(h=0;h<z;h++){var f=e.eq(h).width();g+f>r+4&&(g=0);g+=f+5+2}g=r-g;q.width(25>g?r:g);void 0!==b&&(B[b]=d,c(),(!a.title0&&0==b||0<b)&&q.val(""));y[z?"hide":"show"]()}function f(){if(!s.hasClass("rs")){s.addClass("rs");var a=v.find(".selun"),c=v[0];a.removeClass("ov");for(h=0;h<a.length;h++){var d=
a.eq(h);if(d.attr("val")==t){d.addClass("ov");d=d[0];a=d.offsetTop+d.offsetHeight;170<a&&(d=250,x>a&&(d-=120<x-a?120:x-a),c.scrollTop=a-d);break}}$(document).on("click."+p+"_select",n).on("keydown."+p+"_select",b)}}function n(){q.is(":focus")||(s.removeClass("rs"),a.write&&!t&&(q.val()&&(q.val(""),a.funcKeyup("")),e(0),a.func(0,p)),$(document).off("click."+p+"_select").off("keydown."+p+"_select"))}var l=$(this),h,m,p=l.attr("id"),t=l.val()||0;switch(typeof a){default:case "number":case "string":m=
window[p+"_select"];switch(a){case "process":m.process();break;case "cancel":m.cancel();break;case "title":return m.title();case "remove":$("#"+p+"_select").remove();break;default:REGEXP_NUMERIC.test(a)&&m.value(a)}return l;case "object":if("length"in a)return m=window[p+"_select"],m.spisok(a),l;if(!("spisok"in a))return l}a=$.extend({width:150,block:!1,bottom:0,title0:"",spisok:[],limit:0,write:!1,nofind:"Список пуст",multiselect:0,func:function(){},funcAdd:null,funcKeyup:function(){a.spisok=[];
for(h=0;h<A.length;h++){var b=A[h];a.spisok.push({uid:b.uid,title:b.title,content:b.content})}c()}},a);a.multiselect&&(a.write=!0);var r=a.width-17-5-4;a.funcAdd&&(r-=18);m='<div class="_select" id="'+p+'_select" style="width:'+a.width+"px"+(a.block?";display:block":"")+(a.bottom?";margin-bottom:"+a.bottom+"px":"")+'"><div class="title0bg">'+a.title0+'</div><table class="seltab"><tr><td class="selsel"><input type="text" class="selinp" style="width:'+r+"px"+(a.write?"":";cursor:default")+'"'+(a.write?
"":" readonly")+" />"+(a.funcAdd?'<td class="seladd">':"")+'<td class="selug"></table><div class="selres" style="width:'+a.width+'px"></div></div>';l.next().remove("._select");l.after(m);var s=l.next(),q=s.find(".selinp"),C=s.find(".selsel"),v=s.find(".selres"),x,y=s.find(".title0bg"),w,A=[],B={},z=0,D=/(<[\/]?[_a-zA-Z0-9=\"' ]*>)/i,E={38:1,40:1,13:1,27:1,9:1};d();if(a.multiselect){if(0!=t)for(m=t.split(","),h=0;h<m.length;h++)B[m[h]]=!0,q.before('<div class="multi">'+w[m[h]]+'<span class="x" val="'+
m[h]+'"></span></div>');g()}a.funcAdd&&s.find(".seladd").click(a.funcAdd);c();e(t);var u=q.val();$(document).on("click","#"+p+"_select .selug",f).on("click","#"+p+"_select .selsel",function(){q.focus()}).on("click","#"+p+"_select .selun",function(){k($(this))}).on("mouseenter","#"+p+"_select .selun",function(){v.find(".ov").removeClass("ov");$(this).addClass("ov")}).on("click","#"+p+"_select .x",function(b){b.stopPropagation();b=$(this).attr("val");$(this).parent().remove();g(b,!1);e(b);a.func(b,
p)});q.focus(function(){f();a.write&&y.css("color","#ccc")}).blur(function(){a.write&&y.css("color","#888")}).keyup(function(b){E[b.keyCode]||(y[q.val()||z?"hide":"show"](),u!=q.val()&&(u=q.val(),a.funcKeyup(u),l.val(0),t=0))});l.value=e;l.process=function(){q.addClass("_busy")};l.cancel=function(){q.removeClass("_busy")};l.spisok=function(b){a.spisok=b;d();c();l.cancel()};l.title=function(){return w[l.val()]};return window[p+"_select"]=l};
$(document).ajaxError(function(a,c,b){c.responseText&&_dialog({width:600,top:10,head:"Ошибка AJAX-запроса",content:'<textarea style="width:570px;background-color:#fdd">'+c.responseText+"</textarea>",butSubmit:"",butCancel:"Закрыть"}).content.find("textarea").autosize()}).on("click",".debug_toggle",function(){var a=getCookie("debug");setCookie("debug",1==a?0:1);_msg("Debug включен.");document.location.reload()}).on("click","#cache_clear",function(){$.post(AJAX_MAIN,{op:"cache_clear"},function(a){a.success&&
(_msg("Кэш очищен."),document.location.reload())},"json")}).on("click focus",".vkComment .add textarea,.vkComment .cadd textarea",function(){var a=$(this),c=a.next(),b=a.val();c.is(":hidden")&&(a.val("").attr("val",b).css("color","#000").height(26).autosize(),c.show().css("display","inline-block"))}).on("blur",".vkComment .add TEXTAREA,.vkComment .cadd TEXTAREA",function(){var a=$(this);if(!a.val())if(a.parent().parent().hasClass("empty"))a.parent().parent().hide().parent().find("span").show();else{var c=
a.attr("val");a.val(c).css("color","#777").height(13).next().hide()}}).on("click",".vkComment span a",function(){var a=$(this),c=a.parent().parent().next();a.parent().hide();c.show();c.hasClass("empty")&&c.find("textarea").focus()}).on("click",".vkComment .add .vkButton",function(){var a=$(this);if(!a.hasClass("busy")){var c=a.parent().parent().attr("val").split("_"),c={op:"vkcomment_add",table:c[0],id:c[1],txt:$.trim(a.prev().val())};c.txt&&(a.addClass("busy"),$.post(AJAX_MAIN,c,function(b){a.removeClass("busy").hide();
var c=a.prev().attr("val");a.prev().val(c).css("color","#777").height(13);a.parent().after(b.html)},"json"))}}).on("click",".vkComment .cadd .vkButton",function(){var a=$(this);if(!a.hasClass("busy")){for(var c=a.parent(),b,d,e=0;10>e;e++)if(c=c.parent(),c.hasClass("cunit")&&(b=c.attr("val")),c.hasClass("vkComment")){d=c.attr("val").split("_");break}c={op:"vkcomment_add_child",table:d[0],id:d[1],txt:$.trim(a.prev().val()),parent:b};c.txt&&(a.addClass("busy"),$.post(AJAX_MAIN,c,function(b){a.removeClass("busy").hide();
var c=a.prev().attr("val");a.prev().val(c).css("color","#777").height(13);a.parent().before(b.html).parent().removeClass("empty")},"json"))}}).on("click",".vkComment .unit_del",function(){for(var a=$(this);!a.hasClass("cunit");)a=a.parent();if(!a.hasClass("busy")){var c=a.attr("val"),b={op:"vkcomment_del",id:c};a.addClass("busy");$.post(AJAX_MAIN,b,function(b){a.removeClass("busy");b.success&&a.find("table:first").hide().before('<div class="deleted">Заметка удалена. <a class="unit_rest" val="'+c+
'">Восстановить</a></div>')},"json")}}).on("click",".vkComment .unit_rest,.vkComment .child_rest",function(){var a=$(this);if(!a.hasClass("busy")){var c={op:"vkcomment_rest",id:a.attr("val")};a.addClass("busy");$.post(AJAX_MAIN,c,function(b){a.parent().next().show();a.parent().remove()},"json")}}).on("click",".vkComment .child_del",function(){for(var a=$(this);!a.hasClass("child");)a=a.parent();if(!a.hasClass("busy")){var c=a.attr("val"),b={op:"vkcomment_del",id:c};a.addClass("busy");$.post(AJAX_MAIN,
b,function(b){a.removeClass("busy");b.success&&a.find("table:first").hide().before('<div class="deleted">Комментарий удалён. <a class="child_rest" val="'+c+'">Восстановить</a></div>')},"json")}}).on("click",".fotoView",function(){function a(){var a=window.fotoViewImages.length,b=window.fotoViewNum,c=b+1>=a?0:b+1,e=window.fotoViewImages[b];g.find(".head em").html(1<a?"Фотография "+(b+1)+" из "+a:"Просмотр фотографии");g.find(".dtime").html("Добавлена "+e.dtime);g.find(".image img").attr("src",e.link).attr("width",
e.x).attr("height",e.y).on("load",d);g.find(".hide").html('<img src="'+window.fotoViewImages[c].link+'">')}function c(){g.find(".image").on("click",function(){var c=window.fotoViewImages.length;1==c?b():(window.fotoViewNum++,window.fotoViewNum>=c&&(window.fotoViewNum=0),a())})}function b(){window.fotoViewNum=0;g.remove();FOTO_HEIGHT=0;_fbhs()}function d(){FOTO_HEIGHT=g.height();_fbhs()}$("#foto_view").remove();var e=$(this),k='<div id="foto_view"><div class="head"><EM><img src="/img/upload.gif"></EM><A>Закрыть</A></div><table class="image"><tr><td><img src="'+
e.attr("src").replace("small","big")+'"></table><div class="about"><div class="dtime"></div></div><div class="hide"></div></div>';FB.append(k);var g=$("#foto_view");d();g.find(".head a").on("click",b);var f=e.attr("val"),e={op:"foto_load",owner:f};window.fotoViewImages&&window.fotoViewOwner==f?(a(),c()):$.post(AJAX_MAIN,e,function(b){window.fotoViewImages=b.img;window.fotoViewNum=0;window.fotoViewOwner=f;a();c()},"json")}).on("click",".check0,.check1",function(){var a=$(this),c=a.find("input"),b=
c.val(),d=1==b?0:1;a.removeClass("check"+b);a.addClass("check"+d);c.val(d)}).on("click","._radio .on,._radio .off",function(){var a=$(this),c=a.parent(),b=a.attr("val");c.find("div.on").removeClass("on").addClass("off");a.removeClass("off").addClass("on");c.find("input:first").val(b)}).on("click","._calendarFilter .week-num,._calendarFilter .on,._calendarFilter .data a",function(){for(var a=$(this),c=a.hasClass("week-num")?a.parent():a,b=c.hasClass("sel"),d=c,a=a.attr("val");!d.hasClass("_calendarFilter");)d=
d.parent();b||d.find(".sel").removeClass("sel");c[(b?"remove":"add")+"Class"]("sel");d.find(".selected").val(b?"":a);window._calendarFilter&&_calendarFilter(b?"":a)}).on("click","._calendarFilter .ch",function(){for(var a=$(this),c={op:"calendar_filter_rewind",month:a.attr("val")};!a.hasClass("_calendarFilter");)a=a.parent();a.hasClass("busy")||(a.addClass("busy"),c.func=a.find(".func").val(),c.sel=a.find(".selected").val(),c.noweek=a.find(".noweek").val(),$.post(AJAX_MAIN,c,function(b){a.removeClass("busy");
b.success&&a.find(".content").html(b.html)},"json"))}).on("change","._image-add input",function(){function a(a){a.stopPropagation();for(var b=$(this);"A"!=b[0].tagName;)b=b.parent();b.hasClass("deleting")||(b.addClass("deleting"),a={op:"image_del",id:b.attr("val")},$.post(AJAX_MAIN,a,function(a){a.success?b.remove():b.removeClass("deleting")},"json"))}var c,b=$(this).parent(),d=b.parent();setCookie("_upload","process");c=setInterval(function(){var e=getCookie("_upload");if("process"!=e)switch(clearInterval(c),
d.removeClass("busy"),b.find("input[type=file]").remove(),b.append('<input type="file" name="f1" /><input type="file" name="f2" class="f2" /><input type="file" name="f3" class="f3" />'),e=e.split("_"),e[0]){case "uploaded":e=getCookie("_param").split("_");1==e[2]&&$("._image-add").addClass("dn");$("._image-spisok").append('<a class="_iview" val="'+e[1]+'"><div class="del'+_tooltip("Удалить",-29)+'<em></em></div><img src="'+e[0].replace(/%3A/,":").replace(/%2F/g,"/")+'" /></a>').find(".del:last").click(a);
break;case "error":switch(e[1]){default:case "0":e="Неизвестная ошибка";break;case "1":e="Неверный формат файла";break;case "2":e="Слишком маленькое изображение";break;case "3":e="Превышено количество закружаемых изображений"}$("._image-error").html(e).show().delay(1E3).fadeOut(2E3)}},500);b.submit();d.addClass("busy")}).on("click","._iview",function(){function a(){var a=n.length,b=l+1>=a?0:l+1,c=n[l];f.find(".head em").html(1<a?"Фотография "+(l+1)+" из "+a:"Просмотр фотографии");f.find(".dtime").html("Добавлена "+
c.dtime);f.find(".image img").attr("src",c.link).attr("width",c.x).attr("height",c.y).on("load",d);f.find(".hide").html('<img src="'+n[b].link+'">')}function c(){f.find(".image").on("click",function(){var c=n.length;1==c?b():(l++,l>=c&&(l=0),a())})}function b(){f.remove();FOTO_HEIGHT=0;_fbhs();VK.callMethod("scrollWindow",g)}function d(){FOTO_HEIGHT=f.height();_fbhs()}$("#_image-view").remove();var e=$(this),k=e.attr("val"),g=VK_SCROLL;"IMG"!=e[0].tagName&&(e=e.find("img"));e='<div id="_image-view"><div class="head"><em class="_busy">&nbsp;</em><a>Закрыть</a></div><table class="image"><tr><td><img src="'+
e.attr("src").replace("-s.","-b.")+'"></table><div class="about"><div class="dtime"></div></div><div class="hide"></div></div>';FB.append(e);var f=$("#_image-view"),n=[],l=1;d();f.find(".head a").click(b);f.find("img:first").on("load",d);$.post(AJAX_MAIN,{op:"image_view",id:k},function(b){f.find("._busy").removeClass("_busy");b.success&&(n=b.img,l=b.n,a(),c())},"json")}).ready(function(){VK.callMethod("scrollWindow",0);VK.callMethod("scrollSubscribe");VK.addCallback("onScroll",function(a){VK_SCROLL=
a});FB=$("#frameBody");FH=$("#frameHidden");_fbhs();sortable();$(".pagehelp_create").click(function(){var a=$(this).attr("val"),c=_dialog({top:10,width:610,head:"Создание новой подсказки",content:'<TABLE class="pagehelp_tab"><TR><TD class="label">Страница:<TD><b>'+a+'</b><TR><TD class="label">Название:<TD><input type="text" id="name" maxlength="200"><TR><TD class="label">Содержание:<TD><TR><td colspan="2"><textarea id="pagehelp_txt"></textarea></TABLE>',submit:function(){var b={op:"pagehelp_add",
page:a,name:$("#name").val(),txt:$("#pagehelp_txt").val()};b.name?(c.process(),$.post(AJAX_MAIN,b,function(a){a.success?(c.close(),_msg("Внесёно!"),document.location.reload()):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Не введено название</SPAN>',remove:1,indent:40,show:1,top:-48,left:217}),$("#name").focus())}});$("#name").focus();$("#pagehelp_txt").autosize()});$("#mainLinks .img_pagehelp").click(function(){function a(a){return'<div class="headName">'+a.name+a.edit+'</div><div class="pagehelp_show_txt">'+
a.txt+a.dtime+"</div>"}function c(a){e=_dialog({top:10,width:610,head:"Информация о странице",load:a?0:1,content:a,butSubmit:"",butCancel:"Закрыть"})}function b(g){e.close();e=_dialog({top:10,width:610,head:"Редактирование подсказки",content:'<TABLE class="pagehelp_tab"><TR><TD class="label">Страница:<TD><b>'+g.page+'</b><TR><TD class="label">Название:<TD><input type="text" id="name" maxlength="200" value="'+g.name+'"><TR><TD class="label">Содержание:<TD><TR><td colspan="2"><textarea id="pagehelp_txt">'+
g.txt+"</textarea></TABLE>",butSubmit:"Сохранить",submit:function(){var f={op:"pagehelp_edit",id:d,name:$("#name").val(),txt:$("#pagehelp_txt").val()};f.name?(e.process(),$.post(AJAX_MAIN,f,function(){g.success?(e.close(),g.name=f.name,g.txt=f.txt,c(a(g)),e.content.find(".add").click(function(){b(g)})):e.abort()},"json")):(e.bottom.vkHint({msg:'<SPAN class="red">Не введено название</SPAN>',remove:1,indent:40,show:1,top:-48,left:217}),$("#name").focus())}});$("#name").focus();$("#pagehelp_txt").autosize()}
var d=$(this).attr("val"),e,k={op:"pagehelp_get",id:d};c();$.post(AJAX_MAIN,k,function(c){c.success?e.content.html(a(c)).find(".add").click(function(){b(c)}):e.loadError()},"json")});imageSortable();window.frameHidden.onresize=_fbhs;0<$("#admin").length&&$("#admin em").html(((new Date).getTime()-TIME)/1E3)});
