var VK_SCROLL=0,ZINDEX=0,BC=0,FB,FH,FB_HEIGHT=0,DIALOG_MAXHEIGHT=0,FOTO_HEIGHT=0,REGEXP_NUMERIC=/^\d+$/,REGEXP_CENA=/^[\d]+(.[\d]{1,2})?$/,REGEXP_DATE=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,MONTH_DEF={1:"Январь",2:"Февраль",3:"Март",4:"Апрель",5:"Май",6:"Июнь",7:"Июль",8:"Август",9:"Сентябрь",10:"Октябрь",11:"Ноябрь",12:"Декабрь"},MONTH_DAT={1:"января",2:"февраля",3:"марта",4:"апреля",5:"мая",6:"июня",7:"июля",8:"августа",9:"сентября",10:"октября",11:"ноября",12:"декабря"},URL="http://"+DOMAIN+"/index.php?"+
VALUES,AJAX_MAIN="http://"+DOMAIN+"/ajax/main.php?"+VALUES,setCookie=function(a,c){var b=new Date;b.setDate(b.getDate()+1);document.cookie=a+"="+c+"; path=/; expires="+b.toGMTString()},getCookie=function(a){a=document.cookie.split(a);return 1<a.length?(a=a[1].split(/;/)[0].split(/=/),a[0]?a[0]:a[1]):null},delCookie=function(a){var c=new Date;c.setDate(c.getDate()-1);document.cookie=a+"=; path=/; expires="+c.toGMTString()},sortable=function(){$("._sort").sortable({axis:"y",update:function(){for(var a=
$(this).find("dd"),c=[],b=0;b<a.length;b++)c.push(a.eq(b).attr("val"));a={op:"sort",table:$(this).attr("val"),ids:c.join()};$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,a,function(a){$("#mainLinks").removeClass("busy")},"json")}})},_end=function(a,c){2==c.length&&c.push(c[1]);var b=c[2];if(1!=Math.floor(a/10%10))switch(a%10){case 1:b=c[0];break;case 2:b=c[1];break;case 3:b=c[1];break;case 4:b=c[1]}return b},_fbhs=function(){var a;0<FOTO_HEIGHT?(a=FOTO_HEIGHT,FB.height(a)):(0==DIALOG_MAXHEIGHT&&
FB.height("auto"),a=FB.height(),a<DIALOG_MAXHEIGHT&&(a=DIALOG_MAXHEIGHT,FB.height(a)));FB_HEIGHT!=a&&(FB_HEIGHT=a,VK.callMethod("resizeWindow",625,a))},_backfon=function(a){void 0===a&&(a=!0);var c=$("body");a?(ZINDEX+=10,0==BC&&c.find("._backfon").remove().end().append('<div class="_backfon"></div>'),c.find("._backfon").css({"z-index":ZINDEX}),BC++):(BC--,ZINDEX-=10,0==BC?c.find("._backfon").remove():c.find("._backfon").css({"z-index":ZINDEX}))},_msg=function(a){var c=$("#_msg");0<c.length&&c.remove();
$("body").append("<div id=_msg>"+a+"</div>");$("#_msg").css("top",$(this).scrollTop()+200+VK_SCROLL).delay(1200).fadeOut(400,function(){$(this).remove()})},_dialog=function(a){function c(){g.remove();_backfon(!1);0==b&&(DIALOG_MAXHEIGHT=0);_fbhs()}$(this).attr("id");a=$.extend({width:360,top:100,head:"head: Название заголовка",load:0,content:"content: содержимое центрального поля",submit:function(){},cancel:function(){},butSubmit:"Внести",butCancel:"Отмена"},a);a.load&&(a.content='<div class="load busy"><div class="ms">В процессе загрузки произошла ошибка.</div></div>');
var b=$(".dFrame").length,d='<div class="_dialog"><div class="head"><div><A class="img_del"></A>'+a.head+'</div></div><div class="dcntr"><iframe class="dFrame" name="dFrame'+b+'"></iframe><div class="content">'+a.content+'</div></div><div class="bottom">'+(a.butSubmit?'<div class="vkButton"><button>'+a.butSubmit+"</button></div>":"")+(a.butCancel?'<div class="vkCancel"><button>'+a.butCancel+"</button></div>":"")+"</div></div>";0==b&&(DIALOG_MAXHEIGHT=0);var g=$("body").append(d).find("._dialog:last"),
e=g.find(".vkButton:last"),d=g.find(".content");g.find(".dFrame");g.find(".img_del").click(c);e.find("button").click(a.submit);g.find(".vkCancel").click(function(){a.cancel();c()});_backfon();g.css({width:a.width+"px",top:$(window).scrollTop()+VK_SCROLL+a.top+"px",left:313-Math.round(a.width/2)+"px","z-index":ZINDEX+5});window["dFrame"+b].onresize=function(){for(var a=$(".dFrame"),b=0,c=0;c<a.length;c++){var d=a.eq(c).height();d>b&&(b=d)}a=b+VK_SCROLL+80;DIALOG_MAXHEIGHT!=a&&(DIALOG_MAXHEIGHT=a,_fbhs())};
return{close:c,process:function(){e.addClass("busy")},abort:function(){e.removeClass("busy")},bottom:g.find(".bottom"),content:d,loadError:function(){g.find(".load").removeClass("busy")}}};
$.fn.fotoUpload=function(a){function c(){var a=getCookie("fotoUpload");if("process"!=a)switch(h&&h.close(),k.html("Выберите файл"),clearInterval(l),a=a.split("_"),a[0]){case "uploaded":a=getCookie("fotoParam").split("_");b(a[0].replace(/%3A/,":").replace(/%2F/g,"/"),a[1],a[2]);break;case "error":d(a[1])}}function b(b,c,d){f.close();_msg("Изображение успешно загружено!");window.fotoViewImages=!1;b={link:b,x:c,y:d,dtime:"сегодня"};a.max_x&&c>a.max_x&&(c=a.max_x,d=Math.round(b.y/b.x*a.max_x));a.max_y&&
d>a.max_y&&(d=a.max_y,c=Math.round(b.x/b.y*a.max_y));b.img='<IMG src="'+b.link+'-big.jpg" width="'+c+'" height="'+d+'">';a.func(b)}function d(a){$("#error_msg").remove();var b="не известна";1==a&&(b="неверный формат файла");2==a&&(b="слишком маленький размер изображения.<BR>Допустимый размер не менее 100x100 px");$("#fotoUpload .webcam").after('<div id="error_msg">Не удалось загрузить изображение.<BR>Причина: '+b+".</div>")}function g(){if(!n.hasClass("busy")){var a=m.val();a&&(a={op:"link",link:a},
n.addClass("busy"),$.post(IMAGE_UPLOAD_PATH,a,function(a){n.removeClass("busy");a.error?d(a.error):b(a.link,a.x,a.y)},"json"))}}function e(){h=_dialog({top:20,width:610,head:"Создание снимка с вебкамеры",content:'<div id="screen"></div>',butSubmit:"Сделать снимок",butCancel:"Закрыть",submit:function(){h.process();setCookie("fotoUpload","process");l=setInterval(c,500);document.getElementById("webcam_movie")._snap(IMAGE_UPLOAD_PATH,100,0,0)}});h.content.css({padding:0,height:"457px"});p.screen=$("#screen");
p.show(608,457);h.content.resizable({minWidth:322,maxWidth:608,minHeight:240,maxHeight:457,resize:function(a,b){var c=b.size.width,d=b.originalSize.width-c;0!=d&&(c-=d,322>c&&(c=322),608<c&&(c=608),b.size.width=c,h.content.parent().css({left:313-Math.round(b.size.width/2)+"px",width:c+"px"}),$(this).width("auto"))},start:function(){p.reset()},stop:function(){var a=h.content.height(),b=h.content.width();p.screen.height(a);p.show(b,a)}})}a=$.extend({owner:!1,func:function(){}},a);if(!a.owner)throw Error("Не указан владелец изображения - <b>owner</b>");
IMAGE_UPLOAD_PATH+="?"+VALUES+"&owner="+a.owner;var f,h,l,k,m,n,p={screen:null,show:function(a,b){},reset:function(){}};$(this).on("click",function(){f=_dialog({top:80,head:"Загрузка изображения",content:'<div id="fotoUpload"><div class="info">Поддерживаются форматы JPG, PNG и GIF.</div><FORM method="post" action="'+IMAGE_UPLOAD_PATH+'" enctype="multipart/form-data" target="upload_frame"><INPUT type="file" id="file_name" name="file_name" /><INPUT type="hidden" name="op" value="file" /></FORM><div id="choose_file">Выберите файл</div><IFRAME name="upload_frame"></IFRAME><div id="direct"><INPUT type="text" id="direct_input" placeholder="или укажите прямую ссылку на изображение.."><a><span>oтправить</span></a></div><div class="webcam">Вы также можете <A>сделать фотографию с вебкамеры »</A></div></div>',
butSubmit:null,butCancel:"Закрыть"});var a=$("#fotoUpload form"),b=$("#file_name");k=$("#choose_file");m=$("#direct_input");n=m.next();if(/MSIE/.test(window.navigator.userAgent))b.on({mouseenter:function(){k.css("background-color","#e9edf1")},mouseleave:function(){k.css("background-color","#eff1f3")}});else k.addClass("no_msie").on("click",function(){b.click()}),a.hide();b.change(function(){k.html("&nbsp;<IMG src=/img/upload.gif>");setCookie("fotoUpload","process");l=setInterval(c,500);a.submit()});
m.keyEnter(g);n.click(g);$("#fotoUpload .webcam a").click(e)})};
$.fn._check=function(a){function c(a,b){var c=a.parent().attr("id");$(document).on("click","#"+c,function(){b(a.val(),a.attr("id"))})}var b=$(this);if("number"==typeof a||"string"==typeof a)return b.val(a).parent().attr("class","check"+a),b;if("function"==typeof a)return c(b,a),b;a=$.extend({name:"",func:function(){}},a);var d=b.attr("id"),g=1==b.val()?1:0;b.val(g);b.wrap('<div class="check'+g+'" id="'+d+'_check">');b.after(a.name);c(b,a.func);return b};
$.fn._radio=function(a){function c(a,b){var c=a.parent().attr("id");$(document).on("click","#"+c,function(){b(a.val(),a.attr("id"))})}var b=$(this),d;if("number"==typeof a||"string"==typeof a){d=b.parent();if(d.hasClass("_radio")){d.find("div.on").attr("class","off");var g=d.find("div");for(d=0;d<g.length;d++){var e=g.eq(d);if(a==e.attr("val")){e.addClass("on");break}}b.val(a)}return b}if("function"==typeof a)return c(b,a),b;a=$.extend({spisok:[],light:0,func:function(){}},a);var g=b.attr("id"),e=
"",f=b.val();for(d=0;d<a.spisok.length;d++)var h=a.spisok[d],e=e+('<div class="'+(f==h.uid?"on":"off")+(a.light?" l":"")+'" val="'+h.uid+'"><s></s>'+h.title+"</div>");b.wrap('<div class="_radio" id="'+g+'_radio">');b.after(e);c(b,a.func);return b};
$.fn._search=function(a){function c(){e.css("color","#ccc")}a=$.extend({width:126,focus:0,txt:"",func:function(){},enter:0},a);var b=$(this);b.html('<div class="_search" style="width:'+a.width+'px"><div class="img_del dn"></div><div class="hold">'+a.txt+'</div><input type="text" style="width:'+(a.width-45)+'px" /></div>');var d=b.find("._search"),g=b.find("input"),e=b.find(".hold"),f=b.find(".img_del");a.focus&&(g.focus(),c());g.focus(c).blur(function(){e.css("color","#777")}).keyup(function(){var b=
0<$(this).val().length;e[(b?"add":"remove")+"Class"]("dn");f[(b?"remove":"add")+"Class"]("dn");a.enter||a.func(g.val())});a.enter&&g.keydown(function(b){13==b.which&&a.func($(this).val())});b.clear=function(){g.val("");f.addClass("dn");e.removeClass("dn")};f.click(function(){b.clear();a.func("")});d.click(function(){g.focus();c()});b.inp=function(a){if(!a)return $.trim(g.val());g.val(a);f.removeClass("dn");e.addClass("dn");return $(this)};return b};
$.fn._calendar=function(a){function c(){var c,d="<tr>",g=k.getFullYear(),f=k.getMonth()+1,h=k.getDate(),e;e=(new Date(a.year,a.mon-1,1)).getDay();e=0==e?7:e;var l=g==a.year&&f==a.mon,r=0==a.lost,v=a.year==m&&a.mon==n,q;c=a.year;q=a.mon;q--;0==q&&(q=12,c--);q=32-(new Date(c,q,32)).getDate();if(1<e)for(c=0;c<e-1;c++)d+="<td>";for(c=1;c<=q;c++){var t="";a.year<g?t=" lost":a.year==g&&a.mon<f?t=" lost":a.year==g&&a.mon==f&&c<h&&(t=" lost");d+='<td class="'+(!t||t&&!r?" sel":"")+(l&&c==h?" b":"")+(v&&c==
p?" set":"")+t+'"'+(!t||t&&!r?' val="'+c+'"':"")+">"+c;e++;8==e&&c!=q&&(d+="<tr>",e=1)}u.html(d).find(".sel").click(b)}function b(){m=a.year;n=a.mon;p=$(this).attr("val");q.html(p+" "+MONTH_DAT[n]+" "+m);f.val(d());a.func(d())}function d(){return m+"-"+(10>n?"0":"")+n+"-"+(10>p?"0":"")+p}function g(b){b.stopPropagation();a.mon--;0==a.mon&&(a.mon=12,a.year--);r.html(MONTH_DEF[a.mon]+" "+a.year);c()}function e(b){b.stopPropagation();a.mon++;13==a.mon&&(a.mon=1,a.year++);r.html(MONTH_DEF[a.mon]+" "+
a.year);c()}var f=$(this),h=f.attr("id"),l=f.val(),k=new Date;a=$.extend({year:k.getFullYear(),mon:k.getMonth()+1,day:k.getDate(),lost:0,func:function(){},place:"right"},a);REGEXP_DATE.test(l)&&(l=l.split("-"),a.year=l[0],a.mon=Math.abs(l[1]),a.day=Math.abs(l[2]));f.wrap('<div class="_calendar" id="'+h+'_calendar">');f.after('<div class="calinp">'+a.day+" "+MONTH_DAT[a.mon]+" "+a.year+'</div><div class="calabs"></div>');var m=a.year,n=a.mon,p=a.day,q=f.next(),s=q.next(),r,u;f.val(d());q.click(function(b){if(!s.html()){b.stopPropagation();
b=$(".calabs");for(var d=0;d<b.length;d++){var f=b.eq(d);f.parent().attr("id").split("_calendar")[0]!=h&&f.html("")}$(document).on("click.calendar"+h,function(){s.html("");$(document).off("click.calendar"+h)});a.year=m;a.mon=n;a.day=p;s.html('<div class="calcal" style="left:'+("right"==a.place?0:-64)+'px"><table class="calhead"><tr><td class="calback"><td class="calmon">'+MONTH_DEF[n]+" "+m+'<td class="calnext"></table><table class="calweeks"><tr><td>Пн<td>Вт<td>Ср<td>Чт<td>Пт<td>Сб<td>Вс</table><table class="caldays"></table></div>');
s.find(".calback").click(g);s.find(".calnext").click(e);r=s.find(".calmon");u=s.find(".caldays");c()}})};
$.fn.years=function(a){a=$.extend({year:(new Date).getFullYear(),start:function(){},func:function(){}},a);var c=$(this),b=c.attr("id");c.after("<div class=years id=years_"+b+"><TABLE><TR><TD class=but>&laquo;<TD id=ycenter><SPAN>"+a.year+"</SPAN><TD class=but>&raquo;</TABLE></div>");c.val(a.year);var d={left:0,speed:2,span:$("#years_"+b+" #ycenter SPAN"),width:Math.round($("#years_"+b+" #ycenter").css("width").split(/px/)[0]/2),ismove:0,next:function(b){a.start();if(0==d.ismove){d.ismove=1;var e=
0,f=setInterval(function(){var h=d.span;d.left-=d.speed*b;if(0<d.left&&1==e&&-1==b||0>d.left&&1==e&&1==b)d.left=0,d.ismove=0,d.speed=0,clearInterval(f);h[0].style.left=d.left+"px";d.speed+=2;if(d.left>d.width&&0==e&&-1==b||d.left<-d.width&&0==e&&1==b)e=1,a.year+=b,h.html(a.year),d.left=d.width*b,c.val(a.year),a.func(a.year)},25)}}};$("#years_"+b+" .but:first").mousedown(function(){allmon=1;d.next(-1)});$("#years_"+b+" .but:eq(1)").mousedown(function(){allmon=1;d.next(1)})};
$.fn.keyEnter=function(a){$(this).keydown(function(c){13==c.keyCode&&a()});return $(this)};
$.fn.rightLink=function(a){function c(a,b){var c=a.parent();c.find("a").click(function(){c.find(".sel").removeClass("sel");$(this).addClass("sel");var d=$(this).attr("val");a.val(d);b(d)})}var b=$(this),d;if("number"==typeof a||"string"==typeof a){d=b.parent();if(d.hasClass("rightLink")){d.find(".sel").removeClass("sel");var g=d.find("a");for(d=0;d<g.length;d++){var e=g.eq(d);if(a==e.attr("val")){e.addClass("sel");break}}b.val(a)}return b}if("function"==typeof a)return c(b,a),b;a=$.extend({spisok:[],
func:function(){}},a);b.attr("id");g="";e=b.val();for(d=0;d<a.spisok.length;d++)var f=a.spisok[d],g=g+("<a "+(e==f.uid?'class="sel"':"")+' val="'+f.uid+'">'+f.title+"</a>");b.wrap('<div class="rightLink">');b.after(g);c(b,a.func);return b};
$.fn.linkMenu=function(a){a=$.extend({head:"",spisok:[],func:function(){}},a);var c,b=$(this),d=b.attr("id"),g=b.val(),e=a.head,f=a.spisok.length,h="",l;for(c=0;c<f;c++){var k=a.spisok[c],h=h+('<div class="lmu'+(c==f-1?" last":"")+'" val="'+k.uid+'">'+k.title+"</div>");g==k.uid&&(e=k.title)}b.wrap('<div class="linkMenu" id="'+d+'_linkMenu">');b.after('<a class="lmhead">'+e+'</a><div class="lmlist"><div class="lmsel">'+e+"</div>"+h+"</div>");var m=b.next().next(),n=m.find(".lmsel");b.next().click(function(){m.show()});
n.click(function(){m.hide()});m.find(".lmu").click(function(){b.val($(this).attr("val"));var a=$(this).html();b.next().html(a);n.html(a);m.hide()});m.on({mouseleave:function(){l=setTimeout(function(){m.fadeOut(150)},500)},mouseenter:function(){clearTimeout(l)}})};
(function(){var a=function(a,b){this.create(a,b);return a};a.prototype.create=function(a,b){function d(){function a(){n="showing";h.css({top:b.top,left:b.left}).animate({top:k,left:m,opacity:"show"},200,c)}function c(){n="show";if(0!=b.correct)$(document).on("keydown.hint",function(a){a.preventDefault();switch(a.keyCode){case 38:b.top--;k--;break;case 40:b.top++;k++;break;case 37:b.left--;m--;break;case 39:b.left++,m++}h.css({top:k,left:m});h.find("#correct_top").html(b.top);h.find("#correct_left").html(b.left)})}
0!=b.correct&&$(document).off("keydown.hint");switch(n){case "wait_to_hidding":clearTimeout(p);n="show";break;case "hidding":n="showing";h.stop().animate({top:k,left:m,opacity:1},200,c);break;case "hidden":0<b.delayShow?(n="wait_to_showing",p=setTimeout(a,b.delayShow)):a()}}function g(){function d(){n="hidding";h.animate({opacity:"hide"},200,function(){n="hidden";0!=b.remove&&(f.remove(),a.off(b.event+".hint"),a.off("mouseleave.hint"))})}0!=b.correct&&$(document).off("keydown.hint");"wait_to_showing"==
n&&(clearTimeout(p),n="hidden");"showing"==n&&(h.stop(),d());"show"==n&&(0<b.delayHide?(n="wait_to_hidding",p=setTimeout(d,b.delayHide)):d())}b=$.extend({msg:"Сообщение подсказки",width:0,event:"mouseenter",ugol:"bottom",indent:"center",top:0,left:0,show:0,delayShow:0,delayHide:0,correct:0,remove:0},b);var e="<TABLE class=cont_table><TR><TD class=ugttd colspan=3>"+("top"==b.ugol?"<div class=ugt></div>":"")+"<TR><TD class=ugltd>"+("left"==b.ugol?"<div class=ugl></div>":"")+"<TD class=cont>"+(1==b.correct?
"<div class=correct>top: <SPAN id=correct_top>"+b.top+"</SPAN> left: <SPAN id=correct_left>"+b.left+"</SPAN></div>":"")+b.msg+"<TD class=ugrtd>"+("right"==b.ugol?"<div class=ugr></div>":"")+"<TR><TD class=ugbtd colspan=3>"+("bottom"==b.ugol?"<div class=ugb></div>":"")+"</TABLE>",e="<TABLE class=hint_table><TR><TD class=side005><TD>"+("<TABLE><TR><TD class=side012><TD>"+e+"<TD class=side012><TR><TD class=b012 colspan=3></TABLE>")+"<TD class=side005><TR><TD class=b005 colspan=3></TABLE>";a.prev().remove(".hint");
a.before("<div class=hint>"+e+"</div>");var f=a.prev(),h=f.find(".hint_table:first");0<b.width&&h.find(".cont_table:first").width(b.width);var e=h.width(),l=h.height();h.hide().css("visibility","visible");var k=b.top,m=b.left;switch(b.ugol){case "top":k=b.top-15;l=h.find(".ugttd:first");"center"==b.indent?l.css("text-align","center"):"right"==b.indent?l.css("text-align","right"):"left"==b.indent?l.css("text-align","left"):isNaN(b.indent)||(l.css("text-align","left"),10>b.indent&&(b.indent=10),b.indent>
e&&(b.indent=e-28),h.find(".ugt:first").css("margin-left",b.indent+"px"));break;case "right":m=b.left+25;e=h.find(".ugrtd:first");"center"==b.indent?e.css("vertical-align","middle"):"bottom"==b.indent?e.css("vertical-align","bottom"):isNaN(b.indent)||(3>b.indent&&(b.indent=3),b.indent>l&&(b.indent=l-31),h.find(".ugr:first").css("margin-top",b.indent+"px"));break;case "bottom":k=b.top+15;l=h.find(".ugbtd:first");"center"==b.indent?l.css("text-align","center"):"right"==b.indent?l.css("text-align","right"):
"left"==b.indent?l.css("text-align","left"):isNaN(b.indent)||(l.css("text-align","left"),10>b.indent&&(b.indent=10),b.indent>e&&(b.indent=e-28),h.find(".ugb:first").css("margin-left",b.indent+"px"));break;case "left":m=b.left-25,e=h.find(".ugltd:first"),"center"==b.indent?e.css("vertical-align","middle"):"bottom"==b.indent?e.css("vertical-align","bottom"):isNaN(b.indent)||(3>b.indent&&(b.indent=3),b.indent>l&&(b.indent=l-31),h.find(".ugl:first").css("margin-top",b.indent+"px"))}a.off(b.event+".hint");
a.off("mouseleave.hint");a.on(b.event+".hint",d);a.on("mouseleave.hint",g);h.on("mouseenter.hint",d);h.on("mouseleave.hint",g);var n="hidden",p=0;0!=b.show&&d()};$.fn.vkHint=function(c){return new a($(this),c)}})();
$.fn.vkSel=function(a){function c(){var b=null!=a.spisok_new?a.spisok_new:a.spisok,c="<DL>",d=0<a.limit&&b.length>a.limit?a.limit:b.length;a.title0&&1==a.ro&&(c+="<DD class='"+(0==a.value?"over":"out")+" title0' val=title0_0>"+a.title0);if(0<d)for(var f=RegExp(">","ig"),e=0;e<d;e++){var g=b[e],h=g.uid==a.value?"over":"out",l=null;g.content&&(l=g.content.replace(f," val=dd_"+g.uid+">"));c+="<DD class="+h+" val=dd_"+g.uid+">"+(l?l:g.title)}else 1!=a.ro&&(c+="<DT class=nofind>"+a.nofind);c+="</DL>";
n.html(c);c=n.find("DD");d=c.length;if(0<d){var m=n.find("DL"),k,b=n.css("height").split(/px/)[0];if(250<b){if(m.css({height:"250px","border-bottom":"#CCC solid 1px"}),k=n.find(".over:first")[0])f=k.offsetTop+k.offsetHeight,170<f&&(e=250,b>f&&(e-=120<b-f?120:b-f),m[0].scrollTop=f-e)}else n.find("DD:last").addClass("last");c.on("mouseenter",function(){$(this).parent().find(".over:first").removeClass("over").addClass("out");$(this).addClass("over")});$(document).on("keyup.vksel_esc",function(a){27==
a.keyCode&&($(document).off("keyup.vksel_esc").off("keydown.vksel"),n.html(""))});m=m[0];$(document).on("keydown.vksel",function(b){for(var f=0;f<d&&!c.eq(f).hasClass("over");f++);switch(b.keyCode){case 38:b.preventDefault();f==d&&(f=1);0<f?(1<d&&c.eq(f).removeClass("over").addClass("out"),k=c.eq(f-1)):k=c.eq(0);k.removeClass("out").addClass("over");k=k[0];m.scrollTop>k.offsetTop&&(m.scrollTop=k.offsetTop);0<k.offsetTop-250-m.scrollTop+k.offsetHeight&&(m.scrollTop=k.offsetTop-250+k.offsetHeight);
break;case 40:b.preventDefault();f==d&&(c.eq(0).removeClass("out").addClass("over"),m.scrollTop=0);f<d-1&&(c.eq(f).removeClass("over").addClass("out"),k=c.eq(f+1),k.removeClass("out").addClass("over"),k=k[0],250<k.offsetTop+k.offsetHeight-m.scrollTop&&(m.scrollTop=k.offsetTop+k.offsetHeight-250),k.offsetTop<m.scrollTop&&(m.scrollTop=k.offsetTop));break;case 13:b.preventDefault(),f<d&&(r(c.eq(f).attr("val").split("_")[1]),n.html(""),a.func&&a.func(a.value))}})}}function b(){for(var b=[],c=0;c<a.spisok.length;c++){var d=
a.spisok[c];b[d.uid]=d.title}h=b}function d(a){a.stopPropagation();a=$(".vkSel");for(var b=0;b<a.length;b++){var c=a.eq(b);c.attr("id").split("vkSel_")[1]!=f&&c.find(".results").html("").end().find(".ugol").css({"border-left":"#FFF solid 1px","background-color":"#FFF"})}}function g(){a.value=0;var b=p.val();if(0<b.length){a.spisok_new=[];for(var d=/(<[/]?[_a-zA-Z0-9="' ]*>)/i,b=RegExp(b,"i"),f=0;f<a.spisok.length;f++){for(var e=a.spisok[f],g=0,h=(e.content||e.title).split(d),k=0;k<h.length;k++){var l=
h[k];if(0<l.length&&!d.test(l)&&b.test(l)){h[k]=l.replace(b,"<EM>$&</EM>");g=1;break}}1==g&&a.spisok_new.push({uid:e.uid,title:e.title,content:h.join("")});if(0<a.limit&&a.spisok_new.length>=a.limit)break}}else a.spisok_new=null;c()}var e=$(this),f=e.attr("id");$("#vkSel_"+f).remove();$(document).off("click.results_hide").on("click.results_hide",function(){$(".vkSel").find(".results").html("").end().find(".ugol").css({"border-left":"#FFF solid 1px","background-color":"#FFF"});$(this).off("keyup.vksel_esc").off("keydown.vksel")});
a=$.extend({width:150,bottom:0,display:"block",title0:"",spisok:[],spisok_new:null,limit:0,value:$(this).val()||0,ro:1,nofind:"Не найдено",func:null,funcAdd:null,funcKeyup:null},a);var h;b();var l="<div class=vkSel id=vkSel_"+f+" style=width:"+a.width+"px;display:"+a.display+";>",l=l+("<TABLE class=main style=width:"+a.width+"px;>"),k=a.width-17-4;a.funcAdd&&(k-=17);l=l+("<TD class=selected style=width:"+k+"px; val=inp_>")+("<INPUT type=text class=inp style=width:"+(k-5)+"px;"+(a.ro?"cursor:default; readonly":
"")+" val=inp_>");a.funcAdd&&(l+="<TD class=add val=add_>");l+="<TD class=ugol val=ugol_>";l+="</TABLE>";l+="<div class=results style=width:"+a.width+"px;></div>";l+="</div>";$(this).after(l);var m=$("#vkSel_"+f),n=m.find(".results"),p=m.find(".inp"),q=0,s;0<a.bottom&&m.css("margin-bottom",a.bottom+"px");var r=function(b){void 0!==b&&(a.value=b);a.title0&&0==a.value?p.val(a.title0).css("color","#888"):p.val(h[a.value]).css("color","#000");e.val(a.value);return this};r();if(!a.ro)p.on("keyup",function(b){38!=
b.keyCode&&40!=b.keyCode&&13!=b.keyCode&&(a.funcKeyup?(b=p.val(),0==q&&s!=b&&(s=b,m.find(".process_inp").remove(),p.before("<div class=process_inp style=width:"+(k-5)+"px;><IMG src=/img/upload.gif></div>"),q=1,a.funcKeyup(b))):g())}).on("blur",function(){r()});m.on({mouseenter:function(){$(this).find(".ugol:first").css({"border-left":"#d2dbe0 solid 1px","background-color":"#e1e8ed"})},mouseleave:function(){0==n.find("DL").length&&$(this).find(".ugol:first").css({"border-left":"#FFF solid 1px","background-color":"#FFF"})},
click:function(b){var f=$(b.target).attr("val");if(f)switch(f=f.split("_"),f[0]){case "ugol":$(document).off("keyup.vksel_esc").off("keydown.vksel");d(b);n.find("DL").length?n.html(""):(null!=a.spisok_new&&0==a.spisok_new.length&&(a.spisok_new=null),c());break;case "add":a.spisok_new=null;a.funcAdd(a.spisok,e.o);break;case "inp":d(b);1!=a.ro&&a.title0&&0==a.value&&p.val("").css("color","#000");0==n.find("DL:first").length?(null!=a.spisok_new&&0==a.spisok_new.length&&(a.spisok_new=null),c()):1!=a.ro&&
g();break;case "title0":r(0);a.func&&a.func(a.value);break;case "dd":r(f[1]),a.func&&a.func(a.value)}}});e.o={spisok:function(c){return void 0!=c?(a.spisok=c,b(),m.find(".process:first").remove(),a.funcKeyup?(m.find(".process_inp:first").remove(),1==q?(g(),q=0):r(0)):r(0),this):a.spisok},val:function(b){return void 0!=b?(r(b),this):a.value},title:function(){return p.val()},add:function(b){a.spisok.unshift(b);h[b.uid]=b.title;return this},process:function(){r(0);p.val("");a.spisok=[];m.find(".process").remove();
p.before("<div class=process><IMG src=/img/upload.gif></div>")},remove:function(){m.remove();return this},item:function(b){for(var c=0;c<a.spisok.length;c++){var d=a.spisok[c];if(d.uid==b)return d}return!1}};return e};
$(document).ajaxError(function(a,c,b){c.responseText&&alert("Ошибка:\n\n"+c.responseText)}).on("click",".debug_toggle",function(){var a=getCookie("debug");setCookie("debug",1==a?0:1);_msg("Debug включен.");document.location.reload()}).on("click","#cache_clear",function(){$.post(AJAX_MAIN,{op:"cache_clear"},function(a){a.success&&(_msg("Кэш очищен."),document.location.reload())},"json")}).on("click focus",".vkComment .add textarea,.vkComment .cadd textarea",function(){var a=$(this),c=a.next(),b=a.val();
c.is(":hidden")&&(a.val("").attr("val",b).css("color","#000").height(26).autosize(),c.show().css("display","inline-block"))}).on("blur",".vkComment .add TEXTAREA,.vkComment .cadd TEXTAREA",function(){var a=$(this);if(!a.val())if(a.parent().parent().hasClass("empty"))a.parent().parent().hide().parent().find("span").show();else{var c=a.attr("val");a.val(c).css("color","#777").height(13).next().hide()}}).on("click",".vkComment span a",function(){var a=$(this),c=a.parent().parent().next();a.parent().hide();
c.show();c.hasClass("empty")&&c.find("textarea").focus()}).on("click",".vkComment .add .vkButton",function(){var a=$(this);if(!a.hasClass("busy")){var c=a.parent().parent().attr("val").split("_"),c={op:"vkcomment_add",table:c[0],id:c[1],txt:$.trim(a.prev().val())};c.txt&&(a.addClass("busy"),$.post(AJAX_MAIN,c,function(b){a.removeClass("busy").hide();var c=a.prev().attr("val");a.prev().val(c).css("color","#777").height(13);a.parent().after(b.html)},"json"))}}).on("click",".vkComment .cadd .vkButton",
function(){var a=$(this);if(!a.hasClass("busy")){for(var c=a.parent(),b,d,g=0;10>g;g++)if(c=c.parent(),c.hasClass("cunit")&&(b=c.attr("val")),c.hasClass("vkComment")){d=c.attr("val").split("_");break}c={op:"vkcomment_add_child",table:d[0],id:d[1],txt:$.trim(a.prev().val()),parent:b};c.txt&&(a.addClass("busy"),$.post(AJAX_MAIN,c,function(b){a.removeClass("busy").hide();var c=a.prev().attr("val");a.prev().val(c).css("color","#777").height(13);a.parent().before(b.html).parent().removeClass("empty")},
"json"))}}).on("click",".vkComment .unit_del",function(){for(var a=$(this);!a.hasClass("cunit");)a=a.parent();if(!a.hasClass("busy")){var c=a.attr("val"),b={op:"vkcomment_del",id:c};a.addClass("busy");$.post(AJAX_MAIN,b,function(b){a.removeClass("busy");b.success&&a.find("table:first").hide().before('<div class="deleted">Заметка удалена. <a class="unit_rest" val="'+c+'">Восстановить</a></div>')},"json")}}).on("click",".vkComment .unit_rest,.vkComment .child_rest",function(){var a=$(this);if(!a.hasClass("busy")){var c=
{op:"vkcomment_rest",id:a.attr("val")};a.addClass("busy");$.post(AJAX_MAIN,c,function(b){a.parent().next().show();a.parent().remove()},"json")}}).on("click",".vkComment .child_del",function(){for(var a=$(this);!a.hasClass("child");)a=a.parent();if(!a.hasClass("busy")){var c=a.attr("val"),b={op:"vkcomment_del",id:c};a.addClass("busy");$.post(AJAX_MAIN,b,function(b){a.removeClass("busy");b.success&&a.find("table:first").hide().before('<div class="deleted">Комментарий удалён. <a class="child_rest" val="'+
c+'">Восстановить</a></div>')},"json")}}).on("click",".fotoView",function(){function a(){var a=window.fotoViewImages.length,b=window.fotoViewNum,c=b+1>=a?0:b+1,e=window.fotoViewImages[b];f.find(".head em").html(1<a?"Фотография "+(b+1)+" из "+a:"Просмотр фотографии");f.find(".dtime").html("Добавлена "+e.dtime);f.find(".image img").attr("src",e.link).attr("width",e.x).attr("height",e.y).on("load",d);f.find(".hide").html('<img src="'+window.fotoViewImages[c].link+'">')}function c(){f.find(".image").on("click",
function(){var c=window.fotoViewImages.length;1==c?b():(window.fotoViewNum++,window.fotoViewNum>=c&&(window.fotoViewNum=0),a())})}function b(){window.fotoViewNum=0;f.remove();FOTO_HEIGHT=0;_fbhs()}function d(){FOTO_HEIGHT=f.height();_fbhs()}$("#foto_view").remove();var g=$(this),e='<div id="foto_view"><div class="head"><EM><img src="/img/upload.gif"></EM><A>Закрыть</A></div><table class="image"><tr><td><img src="'+g.attr("src").replace("small","big")+'"></table><div class="about"><div class="dtime"></div></div><div class="hide"></div></div>';
FB.append(e);var f=$("#foto_view");d();f.find(".head a").on("click",b);var h=g.attr("val"),g={op:"foto_load",owner:h};window.fotoViewImages&&window.fotoViewOwner==h?(a(),c()):$.post(AJAX_MAIN,g,function(b){window.fotoViewImages=b.img;window.fotoViewNum=0;window.fotoViewOwner=h;a();c()},"json")}).on("click",".check0,.check1",function(){var a=$(this),c=a.find("input"),b=1==c.val()?0:1;a.attr("class","check"+b);c.val(b)}).on("click","._radio .on,._radio .off",function(){var a=$(this),c=a.parent(),b=
a.attr("val");c.find("div.on").removeClass("on").addClass("off");a.removeClass("off").addClass("on");c.find("input:first").val(b)}).ready(function(){VK.callMethod("scrollWindow",0);VK.callMethod("scrollSubscribe");VK.addCallback("onScroll",function(a){VK_SCROLL=a});FB=$("#frameBody");FH=$("#frameHidden");_fbhs();sortable();$(".pagehelp_create").click(function(){var a=$(this).attr("val"),c=_dialog({top:10,width:610,head:"Создание новой подсказки",content:'<TABLE class="pagehelp_tab"><TR><TD class="label">Страница:<TD><b>'+
a+'</b><TR><TD class="label">Название:<TD><input type="text" id="name" maxlength="200"><TR><TD class="label">Содержание:<TD><TR><td colspan="2"><textarea id="pagehelp_txt"></textarea></TABLE>',submit:function(){var b={op:"pagehelp_add",page:a,name:$("#name").val(),txt:$("#pagehelp_txt").val()};b.name?(c.process(),$.post(AJAX_MAIN,b,function(a){a.success?(c.close(),_msg("Внесёно!"),document.location.reload()):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Не введено название</SPAN>',
remove:1,indent:40,show:1,top:-48,left:217}),$("#name").focus())}});$("#name").focus();$("#pagehelp_txt").autosize()});$("#mainLinks .img_pagehelp").click(function(){function a(a){return'<div class="headName">'+a.name+a.edit+'</div><div class="pagehelp_show_txt">'+a.txt+a.dtime+"</div>"}function c(a){g=_dialog({top:10,width:610,head:"Информация о странице",load:a?0:1,content:a,butSubmit:"",butCancel:"Закрыть"})}function b(f){g.close();g=_dialog({top:10,width:610,head:"Редактирование подсказки",content:'<TABLE class="pagehelp_tab"><TR><TD class="label">Страница:<TD><b>'+
f.page+'</b><TR><TD class="label">Название:<TD><input type="text" id="name" maxlength="200" value="'+f.name+'"><TR><TD class="label">Содержание:<TD><TR><td colspan="2"><textarea id="pagehelp_txt">'+f.txt+"</textarea></TABLE>",butSubmit:"Сохранить",submit:function(){var e={op:"pagehelp_edit",id:d,name:$("#name").val(),txt:$("#pagehelp_txt").val()};e.name?(g.process(),$.post(AJAX_MAIN,e,function(){f.success?(g.close(),f.name=e.name,f.txt=e.txt,c(a(f)),g.content.find(".add").click(function(){b(f)})):
g.abort()},"json")):(g.bottom.vkHint({msg:'<SPAN class="red">Не введено название</SPAN>',remove:1,indent:40,show:1,top:-48,left:217}),$("#name").focus())}});$("#name").focus();$("#pagehelp_txt").autosize()}var d=$(this).attr("val"),g,e={op:"pagehelp_get",id:d};c();$.post(AJAX_MAIN,e,function(c){c.success?g.content.html(a(c)).find(".add").click(function(){b(c)}):g.loadError()},"json")});window.frameHidden.onresize=_fbhs;0<$("#admin").length&&$("#admin em").html(((new Date).getTime()-TIME)/1E3)});
